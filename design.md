## Домашняя работа 1. Архитектура CLI

### Участники группы

* Носивской Владислав
* Саврасов Михаил
* Левин Лев
* Широков Кирилл

### Структурная диаграмма

![Диаграмма](diagram.svg)

### Правила для лексера и парсера

В этой части будут расписаны формальные правила для лексера и парсера,
которые программист перенесет в код (как именно -- будет расписано
позднее)

Синтаксис отсылается к использованию библиотеки `yecc` (`yacc` для Erlang)

Есть отдельный парсер для команд и для аргументов. Это сделано, чтобы
передавать в парсер аргументов вывод команд при перебрасывании вывода в пайпе.


* Лексер

```
Definitions.

WORD = [$_a-zA-Z][$_a-zA-Z0-9]*
WHITESPACE = [\s\t\n\r]

Rules.

|             : pipe.
=             : assign.
"             : double_quote.
[^"]*         : double_quote_interior.
'             : single_quote.
[^']*         : single_quote_interior.
exit          : exit_token.
{WORD}        : word.
{WHITESPACE}+ : skip_token.
```

* Парсер команд (Оставляет аргументы как есть)

```
Nontermials command, assignment, atom, function, var_name, args.
Terminals pipe, word, double_quote, double_quote_interior, single_quote, single_quote_interior.
Rootsymbol command.

Left pipe. (Левоасс. оператор)

command -> command pipe command.
command -> assignment.
command -> atom.
command -> exit_token.
command -> word.

assignment -> var_name assign word.

atom -> function.
atom -> function args.

args -> arg.
args -> arg args.

arg -> word.
arg -> double_quote double_quote_interior double_quote.
arg -> single_quote single_quote_interior single_quote.

var_name -> word.
function -> word.
```

## Архитектурные сущности

### CLI

Основной компонент для взаимодействия с консолью

Методы:

* Чтение строки из консоли
* Вывести строку в консоль
* Геттеры / Сеттеры для потоков ввода/вывода/ошибок


### Lexer

Лексер для токенизации строки. Возвращает список токенов и остаток строки, который
не получилось разобрать.

Правила для лексера описаны выше, от программиста требуется перевести 
правила в код, согласно формату библиотеки [PLY](https://github.com/dabeaz/ply).

### CommandParser

Парсер для первичной обработки команды. Принимает список токенов, возвращает
AST, построенное с помощью библиотеки [PLY](https://github.com/dabeaz/ply)
по грамматике, приведенной выше. Удаляет знаки кавычек там, где надо.

На выходе AST является полностью разобранной командой.

### EnvironmentHandler

Компонент, отвечающий за работу с переменными среды. Хранит внутренние
переменные, которые ввел пользователь.

По имени переменной выдает значение или записывает новое. Если не удалось найти новую переменную
во внутреннем состоянии -- обращается к системе и просит значение переменной.

### FunctionsExecutor

Компонент, исполняющий команду с ее аргументами.
Внутри себя обращается к `FunctionHandler`, получает вызываемый объект.

Метод исполнения должен возвращать кортеж из кода исполнения, потока выходных данных, потока ошибок.
Корректно завершенный вызов имеет код 0, некорректно завершенный вызов внешней функции имеет
код, который передала система; некорректно завершенный вызов внутренней функции имеет код не равный нулю
на усмотрение разработчика.

### FunctionsHandler

Компонент, хранящий наши реализации команд и обращающийся к системе для 
нереализованных команд.

В случае, если не нашлась наша реализация, возвращает лямбду,
которая при вызове обращается к системной реализации команды.

### Substitute

Производит подстановки переменных в строке. Если строка является корректным присваиванием, обрабатывает его.

Ищет очередной оператор `$` в строке и жадно набирает имя переменной 
до пробельного символа, знака скобки или другого оператора `$`. После чего производит подстановку
с помощью `EnvironmentHandler`. Поддерживает strong и weak quoting.


### ASTWalker

Компонент, содержащий основную логику исполнения команды.

Принимает AST, которое нужно обойти и выполнить. Принимает на вход имя команды и ее аргументы. Если операция является пайпом или присваиванием, выполняет их. Иначе обращается в `FunctionsExecutor`, который хранит реализации остальных команд. 

### Main

Главный модуль.

При запуске создает объекты классов `CLI`, `Substitute`, `CommandParser` (`ASTWalker` имеет только статические методы). Поскольку каждый из соответствующих им модулей не должен знать о других, после создания этих обхектов инициализация не требуется, и программа готова считывать ввод пользователя.

Для получения ввода и вывода на экран, `Main` взаимодействует с `CLI`. Принятая от последнего строка передается в `Substitute`, который подставляет в помеченные `$` места значения переменных. После этого `Main` проводит строку, для которой подстановки значений переменных уже не требуются, через `CommandParser`. Полученное AST дальше отдается в `ASTWalker`, который выполняет распознанные команды, обходя это дерево.

После выполнения команды `Main` получает от `ASTWalker` код возврата, поток ошибок и вывода. Если последние два не пустые, то с помощью `CLI` их содержимое выводится на экран. Далее ожидается новый ввод пользователя.

Программа может завершиться командой `exit` или комбинациями Ctrl+C, Ctrl+D. Первая закрывает приложение, когда ее выполняет `ASTWalker`, остальные отлавливает `Main`.
